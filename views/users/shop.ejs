<%- include("../partials/userheader") %>

<main class="main">
    <div class="row m-4">
        <div class="col-lg-3">
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Category
                </h5>
                <ul class="categories">
                    <% Categorys.forEach(category => { %>
                        <li>
                            <input type="hidden" name="categoryId" value="<%= category.id %>">
                            <a href="<%= category.link %>"><%= category.name %></a>
                        </li>
                    <% }) %>
                </ul>
            </div>
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Sort by
                </h5>
                <ul class="categories">
                    <li><a href="shop-grid-right.html">Popularity</a></li>
                    <li><a href="shop-grid-right.html">Average rating</a></li>
                    <li><a href="shop-grid-right.html">Price: Low to High</a></li>
                    <li><a href="shop-grid-right.html">Price: High to Low</a></li>
                </ul>
            </div>
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Price Range
                </h5>
                <ul class="categories">
                    <li><a href="shop-grid-right.html">$0-$200</a></li>
                    <li><a href="shop-grid-right.html">$200-$400</a></li>
                    <li><a href="shop-grid-right.html">$400-$600</a></li>
                    <li><a href="shop-grid-right.html">$600-$800</a></li>
                    <li><a href="shop-grid-right.html">800$+</a></li>
                </ul>
            </div>
        
        </div>
        <div class="col-lg-9">
            <div class="row product-grid-3">
                <% products.forEach(product => { %>
                <div class="col-lg-4 col-md-4 col-12 col-sm-6">
                    <div class="product-cart-wrap mb-30">
                        <div class="product-img-action-wrap">
                            <div class="product-img product-img-zoom">
                                <a href="/product-single/<%= product.id %>">
                                    <img class="default-img" src="productimages/<%= product.images[0] %>"
                                        alt="<%= product.name %>">
                                </a>
                            </div>
                            <div class="product-content-wrap">
                                <h2><a href="/product-single/<%= product.id %>">
                                        <%= product.name %>
                                    </a></h2>
                                <div class="rating-result" title="">
                                    <span>
                                        <span>
                                            <%= product.rating %>
                                        </span>
                                    </span>
                                </div>
                                <% if (product.afterdiscount > 0) { %>
                                <div class="product-price">
                                    <span class="old-price">
                                        <%= product.price %>
                                    </span>
                                    <span> ₹<%= product.afterdiscount %></span>
                                </div>
                                <% } else { %>
                                <div class="product-price">
                                    <span> ₹<%= product.price %></span>
                                </div>
                                <% } %>
                                <div class="product-action-1 show">
                                    <button class="add-to-cart-button" data-id="<%= product.id %>"><i
                                            class="fi-rs-shopping-bag-add"></i></button>
        
                                    <!-- Heart Symbol Button -->
                                    <button class="add-to-favorites-button" data-id="<%= product.id %>"><i
                                            class="fi-rs-heart"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
        </div>
        
    </div>

    <div class="pagination-area mt-30 mb-50 text-center"> 
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                    </li>
                <% } %>
            </ul>
        </nav>
    </div>

</main>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addToCartButtons = document.querySelectorAll('.add-to-cart-button');
        if (addToCartButtons) {
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const productId = this.getAttribute('data-id');
                    checkStockAndAddToCart(productId);
                });
            });
        }
    });

    async function checkStockAndAddToCart(productId) {
        try {
            const stockUrl = `/product/check-stock/${productId}`;
            const response = await fetch(stockUrl);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            if (data.countinstock > 0) {
                addToCart(productId);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Out of Stock',
                    text: 'This product is currently out of stock.',
                });
            }
        } catch (error) {
            console.error('Error checking stock:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while checking stock availability.',
            });
        }
    }

    function addToCart(productId) {
        const url = `/cart/add/${productId}`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Product added to cart:', data);
            if (data.error === 'Product already in cart') {
                Swal.fire({
                    icon: 'error',
                    title: 'Product Already in Cart',
                    text: 'The selected product is already in your cart.',
                });
            } else {
                window.location.href = '/cart';
            }
        })
        .catch(error => {
            console.error('Error adding product to cart:', error);
            Swal.fire({
                icon: 'info',
                title: 'Product Already in Cart',
                text: 'The selected product is already in your cart.',
            });
        });
    }
</script>





<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addToWishlistButtons = document.querySelectorAll('.add-to-favorites-button');

        addToWishlistButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();

                const productId = this.getAttribute('data-id');
                addToWishlist(productId);
            });
        });

        async function addToWishlist(productId) {
    console.log(productId, "killmilljilll");
    const url = `/wishlist/add/${productId}`;
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId: productId }) // Include productId in the request body
        });
        const data = await response.json();
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: data.message || 'Product added to wishlist.',
            })
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: data.message || 'Failed to add product to wishlist.',
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to add product to wishlist.',
        });
    }
}
    });
</script>

<script>
    const categoryLinks = document.querySelectorAll('.categories li');

    categoryLinks.forEach(li => {
        const link = li.querySelector('a');
        const categoryId = li.querySelector('input[type="hidden"]').value;

        link.addEventListener('click', async (event) => {
            event.preventDefault();

            try {
                const response = await fetch(`/products?categoryId=${categoryId}`);
                const products = await response.json();
                updateProductGrid(products);
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        });
    });

    function updateProductGrid(products) {
        const productGridContainer = document.querySelector('.product-grid-3');
        productGridContainer.innerHTML = '';

        products.forEach(product => {
            const productElement = document.createElement('div');
            productElement.classList.add('col-lg-4', 'col-md-4', 'col-12', 'col-sm-6');
            productElement.innerHTML = `
                <div class="product-cart-wrap mb-30">
                    <div class="product-img-action-wrap">
                        <div class="product-img product-img-zoom">
                            <a href="/product-single/${product.id}">
                                <img class="default-img" src="productimages/${product.images[0]}" alt="${product.name}">
                            </a>
                        </div>
                        <div class="product-content-wrap">
                             <h2><a href="/product-single/${product.id}">${product.name}</a></h2>
                            <div class="rating-result" title="">
                                <span>
                                    
                                </span>
                            </div>
                            ${product.afterdiscount > 0 ? `
                                <div class="product-price">
                                    <span class="old-price">${product.price}</span>
                                    <span>₹${product.afterdiscount}</span>
                                </div>
                            ` : `
                                <div class="product-price">
                                    <span>₹${product.price}</span>
                                </div>
                            `}
                            <div class="product-action-1 show">
                                <button class="add-to-cart-button" data-id="${product.id}"><i class="fi-rs-shopping-bag-add"></i></button>
                                <button class="add-to-favorites-button" data-id="${product.id}"><i class="fi-rs-heart"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            productGridContainer.appendChild(productElement);
        });
    }
</script



    

<%- include("../partials/userfooter") %>
