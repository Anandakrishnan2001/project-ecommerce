<%- include("../partials/userheader") %>

<main class="main">
    <div class="row m-4">
        <div class="col-lg-3">
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Category
                </h5>
                <ul class="categories">
                    <% Categorys.forEach(category => { %>
                        <li><a href="<%= category.link %>"><%= category.name %></a></li>
                    <% }) %>
                </ul>
            </div>
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Sort by
                </h5>
                <ul class="categories">
                    <li><a href="shop-grid-right.html">Popularity</a></li>
                    <li><a href="shop-grid-right.html">Average rating</a></li>
                    <li><a href="shop-grid-right.html">Price: Low to High</a></li>
                    <li><a href="shop-grid-right.html">Price: High to Low</a></li>
                </ul>
            </div>
            <div class="widget-category mb-30">
                <h5 class="section-title style-1 mb-30 wow fadeIn animated">
                    Price Range
                </h5>
                <ul class="categories">
                    <li><a href="shop-grid-right.html">$0-$200</a></li>
                    <li><a href="shop-grid-right.html">$200-$400</a></li>
                    <li><a href="shop-grid-right.html">$400-$600</a></li>
                    <li><a href="shop-grid-right.html">$600-$800</a></li>
                    <li><a href="shop-grid-right.html">800$+</a></li>
                </ul>
            </div>
        
        </div>
        <div class="col-lg-9">
            <div class="row product-grid-3">
                <% products.forEach(product=> { %>
                <div class="col-lg-4 col-md-4 col-12 col-sm-6">
                    <div class="product-cart-wrap mb-30">
                        <div class="product-img-action-wrap">
                            <div class="product-img product-img-zoom">
                                <a href="/product-single/<%=product.id %>">
                                    <img class="default-img" src="productimages/<%= product.images[0] %>"
                                        alt="<%= product.name %>">
                                </a>
                            </div>
                            <div class="product-content-wrap">
                                <h2><a href="/product-single/<%=product.id %>">
                                        <%= product.name %>
                                    </a></h2>
                                <div class="rating-result" title="">
                                    <span>
                                        <span>
                                            <%= product.rating %>
                                        </span>
                                    </span>
                                </div>
                                <div class="product-price">
                                    <span class="old-price">
                                        <%= product.price %>
                                    </span>
                                    <span> â‚¹<%= product.afterdiscount %></span>
                                </div>
                                <div class="product-action-1 show">
                                    <button class="add-to-cart-button" data-id="<%= product.id %>"><i class="fi-rs-shopping-bag-add"></i
                                        ></button>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
        </div>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addToCartButtons = document.querySelectorAll('.add-to-cart-button');
        if (addToCartButtons) {
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const productId = this.getAttribute('data-id');
                    checkStockAndAddToCart(productId);
                });
            });
        }
    });

    async function checkStockAndAddToCart(productId) {
        try {
            const stockUrl = `/product/check-stock/${productId}`;
            const response = await fetch(stockUrl);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            if (data.countinstock > 0) {
                addToCart(productId);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Out of Stock',
                    text: 'This product is currently out of stock.',
                });
            }
        } catch (error) {
            console.error('Error checking stock:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while checking stock availability.',
            });
        }
    }

    function addToCart(productId) {
        const url = `/cart/add/${productId}`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Product added to cart:', data);
            if (data.error === 'Product already in cart') {
                Swal.fire({
                    icon: 'error',
                    title: 'Product Already in Cart',
                    text: 'The selected product is already in your cart.',
                });
            } else {
                window.location.href = '/cart';
            }
        })
        .catch(error => {
            console.error('Error adding product to cart:', error);
            Swal.fire({
                icon: 'info',
                title: 'Product Already in Cart',
                text: 'The selected product is already in your cart.',
            });
        });
    }
</script>




    

<%- include("../partials/userfooter") %>
